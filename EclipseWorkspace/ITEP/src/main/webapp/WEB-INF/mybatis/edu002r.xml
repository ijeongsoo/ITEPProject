<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
	PUBLIC "-//mybatis.org/DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="edu002r">
	
	<select id="selectAll" resultType="kr.co.ibk.itep.dto.EduApproval">
		SELECT EDU002R.EMN, EMP001M.EMM, BRI001M.KRN_BRM, ECD002M.ORG_NM, ECD007M.LOW_CLS_NM, EDU001M.COURSE_NM, EDU001M.EDU_HOUR,
			   EDU001M.REG_ST_DT, EDU001M.REG_ED_DT, EDU001M.EDU_ST_DT, EDU001M.EDU_ED_DT, EDU001M.EDU_COST,
			   EDU001M.LOC, EDU001M.REFUND_YN, ECD003M.STEP_NM, EDU002R.COURSE_CD
		  FROM TB_IEP_EDU001M EDU001M, TB_IEP_EDU002R EDU002R, TB_IEP_ECD002M ECD002M, TB_IEP_ECD007M ECD007M,
               TB_IEP_ECD003M ECD003M, TB_IEP_BRI001M BRI001M, TB_IEP_EMP001M EMP001M
		 WHERE EDU001M.COURSE_CD = EDU002R.COURSE_CD
           AND EDU001M.ORG_CD = ECD002M.ORG_CD
           AND EDU001M.LOW_CLS_CD = ECD007M.LOW_CLS_CD   
           AND EDU002R.STEP_CD = ECD003M.STEP_CD 
           AND EDU002R.EMN = EMP001M.EMN
           AND EMP001M.BLNG_BRCD = BRI001M.BRCD
		   AND EDU002R.STEP_CD in ('30')              
	</select>
	
	<select id="selectDep" resultType="kr.co.ibk.itep.dto.EduApproval" parameterType="String">
		SELECT EDU002R.EMN, EMP001M.EMM, BRI001M.KRN_BRM, ECD002M.ORG_NM, ECD007M.LOW_CLS_NM, EDU001M.COURSE_NM, EDU001M.EDU_HOUR,
			   EDU001M.REG_ST_DT, EDU001M.REG_ED_DT, EDU001M.EDU_ST_DT, EDU001M.EDU_ED_DT, EDU001M.EDU_COST,
			   EDU001M.LOC, EDU001M.REFUND_YN, ECD003M.STEP_NM, EDU002R.COURSE_CD
		  FROM TB_IEP_EDU001M EDU001M, TB_IEP_EDU002R EDU002R, TB_IEP_ECD002M ECD002M, TB_IEP_ECD007M ECD007M,
               TB_IEP_ECD003M ECD003M, TB_IEP_BRI001M BRI001M, TB_IEP_EMP001M EMP001M
		 WHERE EDU001M.COURSE_CD = EDU002R.COURSE_CD
           AND EDU001M.ORG_CD = ECD002M.ORG_CD
           AND EDU001M.LOW_CLS_CD = ECD007M.LOW_CLS_CD   
           AND EDU002R.STEP_CD = ECD003M.STEP_CD 
           AND EDU002R.EMN = EMP001M.EMN
           AND EMP001M.BLNG_BRCD = BRI001M.BRCD          
           AND EDU002R.EMN IN (SELECT EMN
		                 FROM TB_IEP_EMP001M
		                WHERE BLNG_BRCD in (SELECT DISTINCT BLNG_BRCD
		                                 FROM TB_IEP_EMP001M
		                                WHERE EMN = #{emn}))
		   AND EDU002R.STEP_CD in (SELECT CASE WHEN AUTH_CD = '03' THEN '10'
                                       WHEN AUTH_CD = '02' THEN '20'
                                       WHEN AUTH_CD = '01' THEN '30'
                                       END
                                       FROM TB_IEP_EMP001M
                                       WHERE EMN = #{emn})              
	</select>
	
	<update id="updateDepApproval" parameterType="Map">	
		UPDATE TB_IEP_EDU002R
		   SET STEP_CD = (CASE WHEN #{auth} = '03' THEN '20'
                            WHEN #{auth} = '02' THEN '30'
                            WHEN #{auth} = '01' THEN '40'
                            END)
		 WHERE EMN = #{emn}
		   AND COURSE_CD = #{course_cd}      
	</update>

</mapper>